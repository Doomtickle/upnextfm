# Learn more about services, parameters and containers at
# https://symfony.com/doc/current/service_container.html
parameters:
    api.request_listener.class: AppBundle\EventListener\RequestListener
    api.controller_response_listener.class: AppBundle\EventListener\ControllerResponseListener
    api.exception_listener.class: AppBundle\EventListener\ExceptionListener

services:
    encoder_json:
      class: Symfony\Component\Serializer\Encoder\JsonEncoder

    normalizer_object:
      class: Symfony\Component\Serializer\Normalizer\ObjectNormalizer

    serializer_json:
      class: Symfony\Component\Serializer\Serializer
      arguments:
        - ["@normalizer_object"]
        - ["@encoder_json"]

    ## ########################################################################
    ## Session
    ## ########################################################################
    app.session.handler:
        class: Symfony\Component\HttpFoundation\Session\Storage\Handler\WriteCheckSessionHandler
        arguments:
            - "@snc_redis.session.handler"

    ## ########################################################################
    ## Storage Rooms
    ## ########################################################################
    app.storage.room:
      class: AppBundle\Storage\RoomStorage
      arguments:
        - "@snc_redis.rooms"

    ## ########################################################################
    ## Storage Websocket Driver
    ## ########################################################################
    app.storage.websocket_driver:
      class: AppBundle\Storage\SocketPredisDriver
      arguments:
        - "@snc_redis.websocket_storage"

    ## ########################################################################
    ## API Request Listener
    ## ########################################################################
    api.request_listener:
        class: "%api.request_listener.class%"
        arguments:
          - "@serializer_json"
        tags:
          - { name: kernel.event_listener, event: kernel.request, method: onKernelRequest }

    ## ########################################################################
    ## API Controller Response Listener
    ## ########################################################################
    api.controller_response_listener:
        class: "%api.controller_response_listener.class%"
        arguments:
          - "@serializer_json"
        tags:
          - { name: kernel.event_listener, event: kernel.view, method: onKernelView }

    ## ########################################################################
    ## API Exception Listener
    ## ########################################################################
    api.exception_listener:
        class: "%api.exception_listener.class%"
        arguments:
          - "@serializer_json"
        tags:
          - { name: kernel.event_listener, event: kernel.exception, method: onKernelException }

    ## ########################################################################
    ## Websocket Parent Topic
    ## ########################################################################
    app.topic.parent:
        arguments:
          - "@service_container"
          - "@?monolog.logger.websocket"
        abstract: true
        private: true

    ## ########################################################################
    ## Websocket Auth Topic
    ## ########################################################################
    app.topic.auth:
        class: AppBundle\Topic\AuthTopic
        parent: app.topic.parent
        tags:
          - { name: gos_web_socket.topic }

    ## ########################################################################
    ## Websocket Room Topic
    ## ########################################################################
    app.topic.room:
        class: AppBundle\Topic\RoomTopic
        parent: app.topic.parent
        calls:
          - [setRoomStorage, ["@app.storage.room"]]
        tags:
          - { name: gos_web_socket.topic }

    ## ########################################################################
    ## Websocket Private Message Topic
    ## ########################################################################
    app.topic.pms:
        class: AppBundle\Topic\PrivateMessageTopic
        parent: app.topic.parent
        calls:
          - [setRoomStorage, ["@app.storage.room"]]
        tags:
          - { name: gos_web_socket.topic }

    ## ########################################################################
    ## Websocket Video Topic
    ## ########################################################################
    app.topic.video:
        class: AppBundle\Topic\VideoTopic
        parent: app.topic.parent
        calls:
          - [setRedis, ["@snc_redis.video"]]
        tags:
          - { name: gos_web_socket.topic }

    ## ########################################################################
    ## Video Periodic
    ## ########################################################################
    app.video.periodic:
      class: AppBundle\Periodic\VideoPeriodic
      calls:
        - [setRedis, ["@snc_redis.video"]]
      tags:
        - { name: gos_web_socket.periodic }

    ## ########################################################################
    ## Doctrine Periodic
    ## ########################################################################
    app.doctrine.periodic:
      class: AppBundle\Periodic\DoctrinePeriodic
      calls:
        - [setEntityManager, ["@doctrine.orm.entity_manager"]]
        - [setLogger, ["@?monolog.logger.websocket"]]
      tags:
        - { name: gos_web_socket.periodic }

    ## ########################################################################
    ## YouTube Service
    ## ########################################################################
    madcoda.youtube.youtube:
      class: Madcoda\Youtube\Youtube
      arguments:
        - { key: "%app_service_youtube_api_key%" }

    ## ########################################################################
    ## Video Info Service
    ## ########################################################################
    app.service.video:
      class: AppBundle\Service\Video
      arguments:
        - "@monolog.logger"
      calls:
        - [setYoutube, ["@madcoda.youtube.youtube"]]

    ## ########################################################################
    ## Registration Form
    ## ########################################################################
    app.form.registration:
      class: AppBundle\Form\RegistrationType
      tags:
        - { name: form.type, alias: registration }

    ## ########################################################################
    ## Registration Listener
    ## ########################################################################
    app.registration_complet:
      class: AppBundle\Listener\RegistrationListener
      tags:
        - { name: kernel.event_subscriber }

    ## ########################################################################
    ## RabbitMQ Save Video Consumer
    ## ########################################################################
    app_rabbitmq_save_video_consumer:
      class: AppBundle\RabbitMQ\Consumer\SaveVideoConsumer
      arguments:
        - "@service_container"

    ## ########################################################################
    ## Sitemap Event Listeners
    ## ########################################################################
    app.sitemap.playlist_subscriber:
      class:     AppBundle\EventListener\SitemapPlaylistSubscriber
      arguments:
        - "@router"
        - "@doctrine.orm.entity_manager"
      tags:
        - { name: "kernel.event_subscriber", priority: 100 }
